import random
import json
import os
import time
from collections import Counter
from datetime import datetime, timezone, timedelta

# ----------------------- р╕Др╕ер╕▒р╕Зр╕Др╕│р╕Ир╕▓р╕Бр╕Чр╕╡р╣Ир╕Бр╕│р╕лр╕Щр╕Ф (р╣Др╕бр╣Ир╣Ар╕Ыр╕ер╕╡р╣Ир╕вр╕Щр╕лр╕бр╕зр╕Ф) + р╕Ир╕▒р╕Фр╕гр╕░р╕Фр╕▒р╕Ър╕Др╕зр╕▓р╕бр╕вр╕▓р╕Б -----------------------
WORDS_BY_LEVEL = {
    "easy": {
        "animals": ["PANDA", "SHEEP", "HORSE", "GOOSE", "EAGLE", "ZEBRA", "WHALE"],
        "fruits":  ["APPLE", "MANGO", "GRAPE", "LEMON", "PEACH"],
        "tools":   ["RULER", "PHONE", "BOOKS", "TABLE"],
        "instruments": ["AUDIO", "PIANO", "MUSIC", "SOUND", "DRUMS"],
        "colors":  ["GREEN", "BLACK", "BROWN", "WHITE"]
    },
    "medium": {
        "animals": ["HIPPO", "RHINO", "SNAIL"],
        "fruits":  ["MELON", "OLIVE", "BERRY", "GUAVA"],
        "tools":   ["PAPER", "SPOON", "CLOCK"],
        "instruments": ["STAGE", "DANCE", "ALBUM"],
        "colors":  ["CREAM", "LEMON", "PEACH"]
    },
    "hard": {
        "animals": ["HYENA", "SHARK", "SLOTH"],
        "fruits":  ["PLUMS", "COCOA"],
        "tools":   ["BRUSH", "PLATE", "DOLLS"],
        "instruments": ["RHYME", "REMIX", "MIXER", "OPERA", "BANDS"],
        "colors":  ["BEIGE", "AZURE", "AMBER"]
    }
}

ALL_CATEGORIES = ["animals","fruits","tools","instruments","colors"]

ATTEMPTS_FIXED = 6
LEADERBOARD_FILE = "leaderboard.json"
TIMEZONE_OFFSET = 7  # Asia/Bangkok (UTC+7)

def load_leaderboard():
    if not os.path.exists(LEADERBOARD_FILE):
        return {"players": {}}
    try:
        with open(LEADERBOARD_FILE, "r", encoding="utf-8") as f:
            return json.load(f)
    except Exception:
        return {"players": {}}

def save_leaderboard(data):
    with open(LEADERBOARD_FILE, "w", encoding="utf-8") as f:
        json.dump(data, f, ensure_ascii=False, indent=2)

def calc_score(won: bool, attempts_used: int, attempts_allowed: int, difficulty: str) -> int:
    mult = {"easy": 1.0, "medium": 1.4, "hard": 1.8}[difficulty]
    if not won:
        return 0
    base = (attempts_allowed - attempts_used + 1) * 10
    return int(base * mult)

def now_bangkok_iso():
    tz = timezone(timedelta(hours=TIMEZONE_OFFSET))
    return datetime.now(tz).isoformat(timespec="seconds")

def print_leaderboard(lb, top_n=10):
    print("\nЁЯПЖ LEADER BOARD (Top {} р╣Вр╕Фр╕вр╕нр╕┤р╕Зр╕Др╕░р╣Бр╕Щр╕Щр╕Чр╕╡р╣Ир╕Фр╕╡р╕Чр╕╡р╣Ир╕кр╕╕р╕Ф)".format(top_n))
    players = []
    for name, info in lb.get("players", {}).items():
        players.append({
            "name": name,
            "best_score": info.get("best_score", 0),
            "total_score": info.get("total_score", 0),
            "games": info.get("games", 0),
            "last_play": info.get("last_play", "-")
        })
    players.sort(key=lambda x: (x["best_score"], x["total_score"]), reverse=True)
    for idx, p in enumerate(players[:top_n], start=1):
        print(f"{idx:>2}. {p['name']:<12} | best: {p['best_score']:>4} | total: {p['total_score']:>4} | games: {p['games']:>2} | last: {p['last_play']}")

def available_categories(diff: str):
    return [c for c in ALL_CATEGORIES if len(WORDS_BY_LEVEL[diff].get(c, [])) > 0]

def pick_answer(diff: str):
    cats = available_categories(diff)
    if not cats:
        raise ValueError(f"No words configured for difficulty '{diff}'")
    category = random.choice(cats)               # р╕кр╕╕р╣Ир╕бр╕лр╕бр╕зр╕Фр╕нр╕▒р╕Хр╣Вр╕Щр╕бр╕▒р╕Хр╕┤
    answer = random.choice(WORDS_BY_LEVEL[diff][category]).upper()
    return answer, category

# ----------------------- Feedback: custom rule (р╣Ар╕лр╕ер╕╖р╕нр╕Зр╕Чр╕╕р╕Бр╕Хр╕▒р╕зр╕Чр╕╡р╣Ир╕нр╕вр╕╣р╣Ир╣Гр╕Щр╕Др╕│) -----------------------
def feedback(answer: str, guess: str) -> str:
    """
    р╕Бр╕Хр╕┤р╕Бр╕▓ custom:
    - р╕Хр╕гр╕Зр╕Хр╕│р╣Бр╕лр╕Щр╣Ир╕З = р╣Ар╕Вр╕╡р╕вр╕з (ЁЯЯй)
    - р╣Др╕бр╣Ир╕Хр╕гр╕Зр╕Хр╕│р╣Бр╕лр╕Щр╣Ир╕З р╣Бр╕Хр╣И 'р╕Хр╕▒р╕зр╕нр╕▒р╕Бр╕йр╕гр╕бр╕╡р╕нр╕вр╕╣р╣Ир╣Гр╕Щр╕Др╕│р╕Хр╕нр╕Ъ' = р╣Ар╕лр╕ер╕╖р╕нр╕З (ЁЯЯи) р╣Др╕бр╣Ир╕Ир╕│р╕Бр╕▒р╕Фр╕Ир╕│р╕Щр╕зр╕Щ
    - р╣Др╕бр╣Ир╕нр╕вр╕╣р╣Ир╣Гр╕Щр╕Др╕│р╕Хр╕нр╕Ър╣Ар╕ер╕в = р╕Вр╕▓р╕з (тмЬ)
    """
    n = len(answer)
    res = [""] * n
    ans = answer
    gss = guess

    # pass 1: р╣Ар╕Вр╕╡р╕вр╕зр╕Бр╣Ир╕нр╕Щ
    for i in range(n):
        if gss[i] == ans[i]:
            res[i] = "ЁЯЯй"

    # р╕Кр╕╕р╕Фр╕Хр╕▒р╕зр╕нр╕▒р╕Бр╕йр╕гр╕Чр╕▒р╣Йр╕Зр╕лр╕бр╕Фр╕Чр╕╡р╣Ир╕бр╕╡р╣Гр╕Щр╕Др╕│р╕Хр╕нр╕Ъ (р╣Др╕бр╣Ир╕Ир╕│р╕Бр╕▒р╕Фр╕Ир╕│р╕Щр╕зр╕Щ)
    set_in_answer = set(ans)

    # pass 2: р╣Ар╕лр╕ер╕╖р╕нр╕З/р╕Вр╕▓р╕з р╕кр╕│р╕лр╕гр╕▒р╕Ър╕Чр╕╡р╣Ир╕вр╕▒р╕Зр╣Др╕бр╣Ир╣Ар╕Вр╕╡р╕вр╕з
    for i in range(n):
        if res[i] == "ЁЯЯй":
            continue
        ch = gss[i]
        res[i] = "ЁЯЯи" if ch in set_in_answer else "тмЬ"

    return "".join(res)

def play_one_round(diff: str, name: str, lb: dict) -> tuple[bool, int]:
    """р╣Ар╕ер╣Ир╕Щ 1 р╕гр╕нр╕Ъ: р╕Др╕╖р╕Щр╕Др╣Ир╕▓ (р╣Бр╕Юр╣Йр╣Др╕лр╕б, р╕Др╕░р╣Бр╕Щр╕Щр╕гр╕нр╕Ър╕Щр╕╡р╣Й). р╕Цр╣Йр╕▓р╣Бр╕Юр╣Й = True."""
    attempts_allowed = ATTEMPTS_FIXED
    answer, category = pick_answer(diff)
    word_len = len(answer)

    print(f"\nЁЯХ╣я╕П р╕гр╕нр╕Ър╣Гр╕лр╕бр╣И! р╣Вр╕лр╕бр╕Ф: {diff.upper()} | р╕Др╕│р╕вр╕▓р╕з {word_len} | р╣Вр╕нр╕Бр╕▓р╕к: {attempts_allowed}")
    print("ЁЯЯй р╕Цр╕╣р╕Бр╕Хр╕│р╣Бр╕лр╕Щр╣Ир╕З | ЁЯЯи р╕бр╕╡р╕Хр╕▒р╕зр╕Щр╕╡р╣Йр╣Бр╕Хр╣Ир╕Хр╕│р╣Бр╕лр╕Щр╣Ир╕Зр╕Ьр╕┤р╕Ф | тмЬ р╣Др╕бр╣Ир╕бр╕╡р╕Хр╕▒р╕зр╕Щр╕╡р╣Й")
    print("тД╣я╕П р╣Ар╕Фр╕▓р╕Др╕зр╕▓р╕бр╕вр╕▓р╕зр╣Др╕бр╣Ир╕Хр╕гр╕З тЖТ тАШр╣Др╕бр╣Ир╕Хр╕▒р╕Фр╕гр╕нр╕ЪтАЩ | р╕Цр╣Йр╕▓р╣Ар╕лр╕ер╕╖р╕н 1 р╕Др╕гр╕▒р╣Йр╕Зр╕кр╕╕р╕Фр╕Чр╣Йр╕▓р╕в р╕Ир╕░р╣Гр╕Ър╣Й тАШр╕лр╕бр╕зр╕ФтАЩ р╣Гр╕лр╣Йр╕нр╕▒р╕Хр╣Вр╕Щр╕бр╕▒р╕Хр╕┤")

    start_time = time.time()
    won = False
    attempts_used = 0
    used_hint = False

    while attempts_used < attempts_allowed:
        guess = input(f"\nр╕Др╕гр╕▒р╣Йр╕Зр╕Чр╕╡р╣И {attempts_used+1}/{attempts_allowed} - р╕Ыр╣Йр╕нр╕Щр╕Др╕│: ").upper().strip()

        if len(guess) != word_len:
            print(f"тЪая╕П р╕Хр╣Йр╕нр╕Зр╣Ар╕Ыр╣Зр╕Щр╕Др╕│ {word_len} р╕Хр╕▒р╕зр╕нр╕▒р╕Бр╕йр╕г  р╕ер╕нр╕Зр╣Гр╕лр╕бр╣И!")
            continue

        attempts_used += 1

        # р╣Гр╕Кр╣Й feedback р╕Хр╕▓р╕бр╕Бр╕Хр╕┤р╕Бр╕▓р╣Гр╕лр╕бр╣И
        print(feedback(answer, guess))

        if guess == answer:
            print("ЁЯОЙ р╣Ар╕Бр╣Ир╕Зр╕бр╕▓р╕Б! р╕Чр╕▓р╕вр╕Цр╕╣р╕Б")
            won = True
            break

        remaining = attempts_allowed - attempts_used
        if remaining == 1 and not used_hint:
            print(f"ЁЯТб HINT: р╕лр╕бр╕зр╕Фр╕Вр╕нр╕Зр╕Др╕│р╕Щр╕╡р╣Йр╕Др╕╖р╕н тЮЬ {category.upper()}")
            used_hint = True

    if not won:
        print(f"ЁЯТе р╣Бр╕Юр╣Йр╕гр╕нр╕Ър╕Щр╕╡р╣Й! р╕Др╕│р╕Хр╕нр╕Ър╕Др╕╖р╕н: {answer}  (р╕лр╕бр╕зр╕Ф: {category})")

    duration_sec = int(time.time() - start_time)
    played_at = now_bangkok_iso()
    score = calc_score(won, attempts_used, attempts_allowed, diff)

    # р╕нр╕▒р╕Ыр╣Ар╕Фр╕Х leaderboard + р╕Ыр╕гр╕░р╕зр╕▒р╕Хр╕┤ (р╣Др╕бр╣Ир╕вр╕╕р╣Ир╕Зр╕Бр╕▒р╕Ъ тАЬр╕гр╕╡р╣Ар╕Лр╣Зр╕Хр╕Др╕░р╣Бр╕Щр╕Щ sessionтАЭ р╕Хр╕гр╕Зр╕Щр╕╡р╣Й)
    p = lb["players"].get(name, {
        "best_score": 0,
        "total_score": 0,
        "games": 0,
        "last_play": "-",
        "history": []
    })

    p["history"].append({
        "date": played_at,
        "difficulty": diff,
        "category": category,
        "answer": answer,
        "attempts_allowed": attempts_allowed,
        "attempts_used": attempts_used,
        "won": won,
        "used_hint": used_hint,
        "duration_sec": duration_sec,
        "score": score
    })

    p["games"] += 1
    p["total_score"] += score
    p["best_score"] = max(p["best_score"], score)
    p["last_play"] = played_at

    lb["players"][name] = p
    save_leaderboard(lb)

    mm, ss = divmod(duration_sec, 60)
    print(f"\nЁЯУК р╕кр╕гр╕╕р╕Ыр╕гр╕нр╕Ър╕Щр╕╡р╣Й | {'р╕Кр╕Щр╕░' if won else 'р╣Бр╕Юр╣Й'} | р╣Гр╕Кр╣Й {attempts_used}/{attempts_allowed} р╕Др╕гр╕▒р╣Йр╕З | р╣Ар╕зр╕ер╕▓ {mm:02d}:{ss:02d} | р╣Бр╕Хр╣Йр╕б {score}")
    print(f"тЮбя╕П р╕кр╕░р╕кр╕бр╕гр╕зр╕б (р╣Гр╕Щ leaderboard): total {p['total_score']} | best {p['best_score']}")

    return (not won), score  # р╣Бр╕Юр╣Йр╣Др╕лр╕б, р╕Др╕░р╣Бр╕Щр╕Щр╕гр╕нр╕Ър╕Щр╕╡р╣Й

def main():
    print("ЁЯОо WORDLE+ (р╣Ар╕ер╣Ир╕Щр╕Хр╣Ир╕нр╣Ар╕Щр╕╖р╣Ир╕нр╕З; attempts = 6 | р╣Ар╕Фр╕▓р╕Др╕зр╕▓р╕бр╕вр╕▓р╕зр╣Др╕бр╣Ир╕Хр╕гр╕З тАШр╣Др╕бр╣Ир╕Щр╕▒р╕Ър╕гр╕нр╕ЪтАЩ | р╕гр╕нр╕Ър╕кр╕╕р╕Фр╕Чр╣Йр╕▓р╕вр╕бр╕╡ HINT р╕лр╕бр╕зр╕Ф)")
    lb = load_leaderboard()

    name = input("р╣Гр╕кр╣Ир╕Кр╕╖р╣Ир╕нр╕Ьр╕╣р╣Йр╣Ар╕ер╣Ир╕Щ (р╣Гр╕Кр╣Йр╕Кр╕╖р╣Ир╕нр╣Ар╕Фр╕┤р╕бр╣Ар╕Юр╕╖р╣Ир╕нр╣Ар╕Бр╣Зр╕Ър╕Др╕░р╣Бр╕Щр╕Щр╕Хр╣Ир╕н/р╕нр╕▒р╕Ыр╣Ар╕Фр╕Х best): ").strip() or "Player"

    while True:
        diff = input("р╣Ар╕ер╕╖р╕нр╕Бр╕гр╕░р╕Фр╕▒р╕Ър╕Др╕зр╕▓р╕бр╕вр╕▓р╕Б (easy / medium / hard): ").strip().lower()
        if diff in WORDS_BY_LEVEL:
            break
        print("тЪая╕П р╕Юр╕┤р╕бр╕Юр╣Мр╣Бр╕Др╣И easy / medium / hard р╕Щр╕░")

    # ===== Session loop =====
    session_round = 0
    session_points = 0
    while True:
        session_round += 1
        print(f"\n========== ROUND {session_round} | SESSION POINTS: {session_points} ==========")
        lost, got = play_one_round(diff, name, lb)
        session_points += got

        if lost:
            # р╣Бр╕Юр╣Й тЖТ р╕Цр╕▓р╕бр╕Хр╣Ир╕нр╣Др╕лр╕б р╕Цр╣Йр╕▓р╕Хр╣Ир╕нр╣Гр╕лр╣Йр╕гр╕╡р╣Ар╕Лр╣Зр╕Х session_points р╣Ар╕Ыр╣Зр╕Щ 0 (р╣Др╕бр╣Ир╣Бр╕Бр╣Й leaderboard р╕Чр╕╡р╣Ир╕Ър╕▒р╕Щр╕Чр╕╢р╕Бр╣Др╕зр╣Й)
            print(f"\nЁЯЯе р╕Др╕╕р╕Ур╣Бр╕Юр╣Йр╕гр╕нр╕Ър╕ер╣Ир╕▓р╕кр╕╕р╕Ф | SESSION POINTS р╕Бр╣Ир╕нр╕Щр╕гр╕╡р╣Ар╕Лр╣Зр╕Х: {session_points}")
            cont = input("р╕нр╕вр╕▓р╕Бр╣Ар╕ер╣Ир╕Щр╕Хр╣Ир╕нр╣Др╕лр╕б? (y = р╕Хр╣Ир╕н / n = р╕лр╕вр╕╕р╕Ф): ").strip().lower()
            if cont == "y":
                session_points = 0   # <<< р╕гр╕╡р╣Ар╕Лр╣Зр╕Хр╕Др╕░р╣Бр╕Щр╕Щ session
                session_round = 0    # р╕Ир╕░р╕Щр╕▒р╕Ър╕гр╕нр╕Ър╣Гр╕лр╕бр╣Ир╕Хр╕▒р╣Йр╕Зр╣Бр╕Хр╣И 1 р╣Ар╕Юр╕╖р╣Ир╕нр╕Др╕зр╕▓р╕бр╕Кр╕▒р╕Ф
                print("ЁЯФД р╣Ар╕гр╕┤р╣Ир╕б session р╣Гр╕лр╕бр╣И! р╕Др╕░р╣Бр╕Щр╕Щ session р╕Цр╕╣р╕Бр╕гр╕╡р╣Ар╕Лр╣Зр╕Хр╣Ар╕Ыр╣Зр╕Щ 0 (leaderboard р╣Др╕бр╣Ир╣Ар╕Ыр╕ер╕╡р╣Ир╕вр╕Щ)")
                continue
            else:
                print("\nЁЯЫС р╕Ир╕Ър╣Ар╕Бр╕б тАФ р╕Вр╕нр╕Ър╕Др╕╕р╕Ур╕Чр╕╡р╣Ир╣Ар╕ер╣Ир╕Щ! (leaderboard р╕Цр╕╣р╕Бр╕Ър╕▒р╕Щр╕Чр╕╢р╕Бр╕Хр╕▓р╕бр╕гр╕нр╕Ър╕Чр╕╡р╣Ир╕Ьр╣Ир╕▓р╕Щр╕бр╕▓р╣Бр╕ер╣Йр╕з)")
                break

        # р╕Кр╕Щр╕░ тЖТ р╕Цр╕▓р╕бр╕зр╣Ир╕▓р╕Ир╕░р╣Ар╕ер╣Ир╕Щр╕Хр╣Ир╕нр╣Др╕лр╕б
        cont = input("\nтЬЕ р╕Кр╕Щр╕░р╕гр╕нр╕Ър╕Щр╕╡р╣Й! р╣Ар╕ер╣Ир╕Щр╕Хр╣Ир╕нр╣Др╕лр╕б? (y = р╕Хр╣Ир╕н / n = р╕лр╕вр╕╕р╕Ф): ").strip().lower()
        if cont != "y":
            print("\nЁЯЯж р╕Ир╕Ър╣Ар╕Бр╕бр╕Хр╕▓р╕бр╕Др╕│р╕кр╕▒р╣Ир╕З тАФ р╕Др╕░р╣Бр╕Щр╕Щр╣Гр╕Щ leaderboard р╕Цр╕╣р╕Бр╕Ър╕▒р╕Щр╕Чр╕╢р╕Бр╕Хр╕▓р╕бр╕гр╕нр╕Ър╕Чр╕╡р╣Ир╕Ьр╣Ир╕▓р╕Щр╕бр╕▓р╣Бр╕ер╣Йр╕з")
            break

    print_leaderboard(lb, top_n=10)
    print("\nЁЯТ╛ р╕Др╕░р╣Бр╕Щр╕Щр╕Цр╕╣р╕Бр╕Ър╕▒р╕Щр╕Чр╕╢р╕Бр╣Гр╕Щ 'leaderboard.json' тАФ р╕гр╕нр╕Ър╕лр╕Щр╣Йр╕▓р╕Юр╕┤р╕бр╕Юр╣Мр╕Кр╕╖р╣Ир╕нр╣Ар╕Фр╕┤р╕бр╣Ар╕Юр╕╖р╣Ир╕нр╣Ар╕ер╣Ир╕Щр╕Хр╣Ир╕нр╣Др╕Фр╣Йр╣Ар╕ер╕в ЁЯШЙ")

if __name__ == "__main__":
    main()
